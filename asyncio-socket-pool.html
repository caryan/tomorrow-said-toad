
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="http://www.colmryan.org/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="http://www.colmryan.org/theme/pygments/github.min.css">
  <link rel="stylesheet" type="text/css" href="http://www.colmryan.org/theme/font-awesome/css/font-awesome.min.css">


    <link href="http://www.colmryan.org/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Tomorrow Said Toad Atom">





<meta name="author" content="Colm Ryan" />
<meta name="description" content="In a typical client-server over a socket setup the server may take some time to process any given request and so to allow thee client to fire off multiple requests in parallel to speed things up there are two common paths: We can make the server interface asynchronous so that …" />
<meta name="keywords" content="Python">

<meta property="og:site_name" content="Tomorrow Said Toad"/>
<meta property="og:title" content="Asyncio Socket Pool"/>
<meta property="og:description" content="In a typical client-server over a socket setup the server may take some time to process any given request and so to allow thee client to fire off multiple requests in parallel to speed things up there are two common paths: We can make the server interface asynchronous so that …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://www.colmryan.org/asyncio-socket-pool.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2019-08-12 00:00:00-04:00"/>
<meta property="article:modified_time" content="2019-10-28 00:00:00-04:00"/>
<meta property="article:author" content="http://www.colmryan.org/author/colm-ryan.html">
<meta property="article:section" content="Software"/>
<meta property="article:tag" content="Python"/>
<meta property="og:image" content="">

  <title>Tomorrow Said Toad &ndash; Asyncio Socket Pool</title>

</head>
<body>
  <aside>
    <div>
      <a href="http://www.colmryan.org">
        <img src="http://www.colmryan.org/theme/img/profile.png" alt="Tomorrow Said Toad" title="Tomorrow Said Toad">
      </a>
      <h1><a href="http://www.colmryan.org">Tomorrow Said Toad</a></h1>

<p>Today I will take life easy...</p>
      <nav>
        <ul class="list">

          <li><a href="http://getpelican.com/" target="_blank">Pelican</a></li>
          <li><a href="http://python.org/" target="_blank">Python.org</a></li>
        </ul>
      </nav>

      <ul class="social">
        <li><a class="sc-github" href="http://github.com/caryan" target="_blank"><i class="fa fa-github"></i></a></li>
      </ul>
    </div>


  </aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="asyncio-socket-pool">Asyncio Socket Pool</h1>
    <p>
          Posted on Mon 12 August 2019 in <a href="http://www.colmryan.org/category/software.html">Software</a>


    </p>
  </header>


  <div>
    <p>In a typical client-server over a socket setup the server may take some time to process any given
request and so to allow thee client to fire off multiple requests in parallel to speed things up
there are two common paths:</p>
<ol>
<li>We can make the server interface asynchronous so that it is able to take a whole series of
   requests and respond to them out of order.</li>
<li>The server can support multiple socket connections, but each one is
   blocking and so we can parallelize communications across the multiple sockets.</li>
</ol>
<p>The first is more elegant but requires additional work to allow the server to asynchronously
dispatch requests and keep responding to new ones and for the client to handle the out of order
replies. We took that path with the <a href="https://github.com/rigetti/rpcq/tree/master/rpcq">rpcq
client-server</a> For simpler cases, multiple sockets
might be sufficient.</p>
<p>Here is a simple implementation of a client socket pool wrapped an an <a href="https://docs.python.org/3/library/contextlib.html#contextlib.asynccontextmanager">asynccontextmanager
decorator</a> so that
we can nicely <code>async with ...</code> <code>await</code> on the next available socket. To bound the number of sockets
we use an <a href="https://docs.python.org/3/library/asyncio-sync.html#asyncio.Semaphore">asyncio
Semaphore</a>. The semaphore is
an integer that is intialized to the maximum number of sockets. Every time a socket is checked out
from the pool we <code>await</code> on the semphaore, the integer is decremented by one and then finally the
semaphore blocks when the integer would go negative. When we are done with the socket we return it
to the pool and increment the semaphore integer again. All this integer decrement/increment logic is
wrapped with by the Python <code>asyncio</code> module with another <code>asynccontextmanager</code> so all the
bookkeeping so the interface is a simple <code>async with self.semaphore:</code>. We'll return the high-level
<code>asyncio StreamReader/StreamWriter</code> to provide access to the socket.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">asynccontextmanager</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="k">class</span> <span class="nc">SocketPool</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A pool of socket connections for a client to access some server.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">address</span><span class="p">:</span> <span class="nb">str</span>
    <span class="sd">&quot;&quot;&quot; Hostname for the server &quot;&quot;&quot;</span>

    <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1234</span>
    <span class="sd">&quot;&quot;&quot; Port that the instrument is listening for connections on. &quot;&quot;&quot;</span>

    <span class="n">max_num_sockets</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="sd">&quot;&quot;&quot; Maximum number of open sockets to the server &quot;&quot;&quot;</span>

    <span class="n">semaphore</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span>
    <span class="sd">&quot;&quot;&quot; Use a semaphore to bound the number of open connection to `max_num_sockets` &quot;&quot;&quot;</span>

    <span class="n">pool</span><span class="p">:</span> <span class="nb">list</span>
    <span class="sd">&quot;&quot;&quot; List of socket StreamReader, StreamWriter pairs &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_num_sockets</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span>

        <span class="c1"># if we&#39;re passed some `max_num_sockets` or `port` then override the defaults</span>
        <span class="k">if</span> <span class="n">max_num_sockets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_num_sockets</span> <span class="o">=</span> <span class="n">max_num_sockets</span>

        <span class="k">if</span> <span class="n">port</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">semaphore</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_num_sockets</span><span class="p">)</span>

        <span class="c1"># a list to hold onto the (asyncio.StreamReader, asyncio.StreamWriter) tuples for each socket</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@asynccontextmanager</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">StreamReader</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">StreamWriter</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the next available socket reader/writer from the pool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">semaphore</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># take the last socket in the pool</span>
                <span class="n">reader</span><span class="p">,</span> <span class="n">writer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="c1"># empty list so create a new socket</span>
                <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding socket connection to server at </span><span class="si">{self.address}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">reader</span><span class="p">,</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">open_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># hand the reader/writer pair back to the caller</span>
                <span class="k">yield</span> <span class="n">reader</span><span class="p">,</span> <span class="n">writer</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># put the socket back in the pool</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">reader</span><span class="p">,</span> <span class="n">writer</span><span class="p">))</span>
</pre></div>


<p>We can then test this out with a simple echo server that listens for connections and then takes some
time to respond.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_echo</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">writer</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="n">addr</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">get_extra_info</span><span class="p">(</span><span class="s1">&#39;peername&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received </span><span class="si">{message!r}</span><span class="s2"> from </span><span class="si">{addr!r}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Taking a second to process something....&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sending back response.&quot;</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">writer</span><span class="o">.</span><span class="n">drain</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Close the connection&quot;</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">server</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">start_server</span><span class="p">(</span><span class="n">handle_echo</span><span class="p">,</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">1234</span><span class="p">)</span>

    <span class="n">addr</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">sockets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Serving on </span><span class="si">{addr}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">server</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>


<p>And then a simple client side function to use it.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">wherever.socket_pool</span> <span class="kn">import</span> <span class="n">SocketPool</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">send_message</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="c1"># check out a socket</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">pool</span><span class="o">.</span><span class="n">get_socket</span><span class="p">()</span> <span class="k">as</span> <span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">writer</span><span class="p">):</span>
        <span class="c1"># send the message</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
        <span class="k">await</span> <span class="n">writer</span><span class="o">.</span><span class="n">drain</span><span class="p">()</span>
        <span class="c1"># wait for the echo response</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

<span class="n">pool</span> <span class="o">=</span> <span class="n">SocketPool</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span> <span class="n">max_num_sockets</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="n">cryan</span><span class="nd">@cryan</span><span class="o">-</span><span class="n">Precision</span><span class="o">-</span><span class="mi">5510</span><span class="p">:</span><span class="o">~/</span><span class="n">repos</span><span class="o">/</span><span class="n">tomorrow</span><span class="o">-</span><span class="n">said</span><span class="o">-</span><span class="n">toad</span><span class="o">/</span><span class="n">content</span><span class="err">$</span> <span class="n">ipython</span>
<span class="n">Python</span> <span class="mf">3.7</span><span class="o">.</span><span class="mi">4</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Aug</span> <span class="mi">13</span> <span class="mi">2019</span><span class="p">,</span> <span class="mi">20</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">49</span><span class="p">)</span>
<span class="n">Type</span> <span class="s1">&#39;copyright&#39;</span><span class="p">,</span> <span class="s1">&#39;credits&#39;</span> <span class="ow">or</span> <span class="s1">&#39;license&#39;</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span>
<span class="n">IPython</span> <span class="mf">7.8</span><span class="o">.</span><span class="mi">0</span> <span class="o">--</span> <span class="n">An</span> <span class="n">enhanced</span> <span class="n">Interactive</span> <span class="n">Python</span><span class="o">.</span> <span class="n">Type</span> <span class="s1">&#39;?&#39;</span> <span class="k">for</span> <span class="n">help</span><span class="o">.</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="o">%</span><span class="n">paste</span> <span class="c1"># import the client code</span>
<span class="c1"># send a single message and a single socket is created</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="k">await</span> <span class="n">send_message</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="s2">&quot;Hello!&quot;</span><span class="p">)</span>
<span class="n">Adding</span> <span class="n">socket</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">server</span> <span class="n">at</span> <span class="n">localhost</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="s1">&#39;Hello!&#39;</span>

<span class="c1"># we can inspect the pool and see indeed there is one socket there</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">pool</span><span class="o">.</span><span class="n">pool</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
<span class="p">[(</span><span class="o">&lt;</span><span class="n">StreamReader</span> <span class="n">transport</span><span class="o">=&lt;</span><span class="n">_SelectorSocketTransport</span> <span class="n">fd</span><span class="o">=</span><span class="mi">16</span> <span class="n">read</span><span class="o">=</span><span class="n">polling</span> <span class="n">write</span><span class="o">=&lt;</span><span class="n">idle</span><span class="p">,</span> <span class="n">bufsize</span><span class="o">=</span><span class="mi">0</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span>
  <span class="o">&lt;</span><span class="n">StreamWriter</span> <span class="n">transport</span><span class="o">=&lt;</span><span class="n">_SelectorSocketTransport</span> <span class="n">fd</span><span class="o">=</span><span class="mi">16</span> <span class="n">read</span><span class="o">=</span><span class="n">polling</span> <span class="n">write</span><span class="o">=&lt;</span><span class="n">idle</span><span class="p">,</span> <span class="n">bufsize</span><span class="o">=</span><span class="mi">0</span><span class="o">&gt;&gt;</span> <span class="n">reader</span><span class="o">=&lt;</span><span class="n">StreamReader</span> <span class="n">transport</span><span class="o">=&lt;</span><span class="n">_SelectorSocketTransport</span> <span class="n">fd</span><span class="o">=</span><span class="mi">16</span> <span class="n">read</span><span class="o">=</span><span class="n">polling</span> <span class="n">write</span><span class="o">=&lt;</span><span class="n">idle</span><span class="p">,</span> <span class="n">bufsize</span><span class="o">=</span><span class="mi">0</span><span class="o">&gt;&gt;&gt;&gt;</span><span class="p">)]</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="nb">len</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">pool</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="mi">1</span>

<span class="c1"># now send a slew of requests at once and it still takes only a second to respond</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">([</span><span class="n">send_message</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ct</span><span class="p">))</span> <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)])</span>
<span class="n">Adding</span> <span class="n">socket</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">server</span> <span class="n">at</span> <span class="n">localhost</span>
<span class="n">Adding</span> <span class="n">socket</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">server</span> <span class="n">at</span> <span class="n">localhost</span>
<span class="n">Adding</span> <span class="n">socket</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">server</span> <span class="n">at</span> <span class="n">localhost</span>
<span class="n">Adding</span> <span class="n">socket</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">server</span> <span class="n">at</span> <span class="n">localhost</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span>
<span class="p">({</span><span class="o">&lt;</span><span class="n">Task</span> <span class="n">finished</span> <span class="n">coro</span><span class="o">=&lt;</span><span class="n">send_message</span><span class="p">()</span> <span class="n">done</span><span class="p">,</span> <span class="n">defined</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cryan</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">tomorrow</span><span class="o">-</span><span class="n">said</span><span class="o">-</span><span class="n">toad</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">61</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">&lt;</span><span class="n">Task</span> <span class="n">finished</span> <span class="n">coro</span><span class="o">=&lt;</span><span class="n">send_message</span><span class="p">()</span> <span class="n">done</span><span class="p">,</span> <span class="n">defined</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cryan</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">tomorrow</span><span class="o">-</span><span class="n">said</span><span class="o">-</span><span class="n">toad</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">61</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">&lt;</span><span class="n">Task</span> <span class="n">finished</span> <span class="n">coro</span><span class="o">=&lt;</span><span class="n">send_message</span><span class="p">()</span> <span class="n">done</span><span class="p">,</span> <span class="n">defined</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cryan</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">tomorrow</span><span class="o">-</span><span class="n">said</span><span class="o">-</span><span class="n">toad</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">61</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">=</span><span class="s1">&#39;2&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">&lt;</span><span class="n">Task</span> <span class="n">finished</span> <span class="n">coro</span><span class="o">=&lt;</span><span class="n">send_message</span><span class="p">()</span> <span class="n">done</span><span class="p">,</span> <span class="n">defined</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cryan</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">tomorrow</span><span class="o">-</span><span class="n">said</span><span class="o">-</span><span class="n">toad</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">61</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">=</span><span class="s1">&#39;3&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">&lt;</span><span class="n">Task</span> <span class="n">finished</span> <span class="n">coro</span><span class="o">=&lt;</span><span class="n">send_message</span><span class="p">()</span> <span class="n">done</span><span class="p">,</span> <span class="n">defined</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cryan</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">tomorrow</span><span class="o">-</span><span class="n">said</span><span class="o">-</span><span class="n">toad</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">61</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">=</span><span class="s1">&#39;4&#39;</span><span class="o">&gt;</span><span class="p">},</span>
 <span class="nb">set</span><span class="p">())</span>

<span class="c1"># and we have 5 sockets in the pool</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="nb">len</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">pool</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="mi">5</span>

<span class="c1"># finally send even more requests and it takes about 4 seconds to respond as only 5 requests are outstanding at any time</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">([</span><span class="n">send_message</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ct</span><span class="p">))</span> <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)])</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span>
<span class="p">({</span><span class="o">&lt;</span><span class="n">Task</span> <span class="n">finished</span> <span class="n">coro</span><span class="o">=&lt;</span><span class="n">send_message</span><span class="p">()</span> <span class="n">done</span><span class="p">,</span> <span class="n">defined</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cryan</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">tomorrow</span><span class="o">-</span><span class="n">said</span><span class="o">-</span><span class="n">toad</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">61</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">&lt;</span><span class="n">Task</span> <span class="n">finished</span> <span class="n">coro</span><span class="o">=&lt;</span><span class="n">send_message</span><span class="p">()</span> <span class="n">done</span><span class="p">,</span> <span class="n">defined</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cryan</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">tomorrow</span><span class="o">-</span><span class="n">said</span><span class="o">-</span><span class="n">toad</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">61</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">&lt;</span><span class="n">Task</span> <span class="n">finished</span> <span class="n">coro</span><span class="o">=&lt;</span><span class="n">send_message</span><span class="p">()</span> <span class="n">done</span><span class="p">,</span> <span class="n">defined</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cryan</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">tomorrow</span><span class="o">-</span><span class="n">said</span><span class="o">-</span><span class="n">toad</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">61</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">=</span><span class="s1">&#39;10&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">&lt;</span><span class="n">Task</span> <span class="n">finished</span> <span class="n">coro</span><span class="o">=&lt;</span><span class="n">send_message</span><span class="p">()</span> <span class="n">done</span><span class="p">,</span> <span class="n">defined</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cryan</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">tomorrow</span><span class="o">-</span><span class="n">said</span><span class="o">-</span><span class="n">toad</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">61</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">=</span><span class="s1">&#39;11&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">&lt;</span><span class="n">Task</span> <span class="n">finished</span> <span class="n">coro</span><span class="o">=&lt;</span><span class="n">send_message</span><span class="p">()</span> <span class="n">done</span><span class="p">,</span> <span class="n">defined</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cryan</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">tomorrow</span><span class="o">-</span><span class="n">said</span><span class="o">-</span><span class="n">toad</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">61</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">=</span><span class="s1">&#39;12&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">&lt;</span><span class="n">Task</span> <span class="n">finished</span> <span class="n">coro</span><span class="o">=&lt;</span><span class="n">send_message</span><span class="p">()</span> <span class="n">done</span><span class="p">,</span> <span class="n">defined</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cryan</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">tomorrow</span><span class="o">-</span><span class="n">said</span><span class="o">-</span><span class="n">toad</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">61</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">=</span><span class="s1">&#39;13&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">&lt;</span><span class="n">Task</span> <span class="n">finished</span> <span class="n">coro</span><span class="o">=&lt;</span><span class="n">send_message</span><span class="p">()</span> <span class="n">done</span><span class="p">,</span> <span class="n">defined</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cryan</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">tomorrow</span><span class="o">-</span><span class="n">said</span><span class="o">-</span><span class="n">toad</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">61</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">=</span><span class="s1">&#39;14&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">&lt;</span><span class="n">Task</span> <span class="n">finished</span> <span class="n">coro</span><span class="o">=&lt;</span><span class="n">send_message</span><span class="p">()</span> <span class="n">done</span><span class="p">,</span> <span class="n">defined</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cryan</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">tomorrow</span><span class="o">-</span><span class="n">said</span><span class="o">-</span><span class="n">toad</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">61</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">=</span><span class="s1">&#39;15&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">&lt;</span><span class="n">Task</span> <span class="n">finished</span> <span class="n">coro</span><span class="o">=&lt;</span><span class="n">send_message</span><span class="p">()</span> <span class="n">done</span><span class="p">,</span> <span class="n">defined</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cryan</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">tomorrow</span><span class="o">-</span><span class="n">said</span><span class="o">-</span><span class="n">toad</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">61</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">=</span><span class="s1">&#39;16&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">&lt;</span><span class="n">Task</span> <span class="n">finished</span> <span class="n">coro</span><span class="o">=&lt;</span><span class="n">send_message</span><span class="p">()</span> <span class="n">done</span><span class="p">,</span> <span class="n">defined</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cryan</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">tomorrow</span><span class="o">-</span><span class="n">said</span><span class="o">-</span><span class="n">toad</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">61</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">=</span><span class="s1">&#39;17&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">&lt;</span><span class="n">Task</span> <span class="n">finished</span> <span class="n">coro</span><span class="o">=&lt;</span><span class="n">send_message</span><span class="p">()</span> <span class="n">done</span><span class="p">,</span> <span class="n">defined</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cryan</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">tomorrow</span><span class="o">-</span><span class="n">said</span><span class="o">-</span><span class="n">toad</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">61</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">=</span><span class="s1">&#39;18&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">&lt;</span><span class="n">Task</span> <span class="n">finished</span> <span class="n">coro</span><span class="o">=&lt;</span><span class="n">send_message</span><span class="p">()</span> <span class="n">done</span><span class="p">,</span> <span class="n">defined</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cryan</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">tomorrow</span><span class="o">-</span><span class="n">said</span><span class="o">-</span><span class="n">toad</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">61</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">=</span><span class="s1">&#39;19&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">&lt;</span><span class="n">Task</span> <span class="n">finished</span> <span class="n">coro</span><span class="o">=&lt;</span><span class="n">send_message</span><span class="p">()</span> <span class="n">done</span><span class="p">,</span> <span class="n">defined</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cryan</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">tomorrow</span><span class="o">-</span><span class="n">said</span><span class="o">-</span><span class="n">toad</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">61</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">=</span><span class="s1">&#39;2&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">&lt;</span><span class="n">Task</span> <span class="n">finished</span> <span class="n">coro</span><span class="o">=&lt;</span><span class="n">send_message</span><span class="p">()</span> <span class="n">done</span><span class="p">,</span> <span class="n">defined</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cryan</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">tomorrow</span><span class="o">-</span><span class="n">said</span><span class="o">-</span><span class="n">toad</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">61</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">=</span><span class="s1">&#39;3&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">&lt;</span><span class="n">Task</span> <span class="n">finished</span> <span class="n">coro</span><span class="o">=&lt;</span><span class="n">send_message</span><span class="p">()</span> <span class="n">done</span><span class="p">,</span> <span class="n">defined</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cryan</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">tomorrow</span><span class="o">-</span><span class="n">said</span><span class="o">-</span><span class="n">toad</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">61</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">=</span><span class="s1">&#39;4&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">&lt;</span><span class="n">Task</span> <span class="n">finished</span> <span class="n">coro</span><span class="o">=&lt;</span><span class="n">send_message</span><span class="p">()</span> <span class="n">done</span><span class="p">,</span> <span class="n">defined</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cryan</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">tomorrow</span><span class="o">-</span><span class="n">said</span><span class="o">-</span><span class="n">toad</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">61</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">=</span><span class="s1">&#39;5&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">&lt;</span><span class="n">Task</span> <span class="n">finished</span> <span class="n">coro</span><span class="o">=&lt;</span><span class="n">send_message</span><span class="p">()</span> <span class="n">done</span><span class="p">,</span> <span class="n">defined</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cryan</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">tomorrow</span><span class="o">-</span><span class="n">said</span><span class="o">-</span><span class="n">toad</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">61</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">=</span><span class="s1">&#39;6&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">&lt;</span><span class="n">Task</span> <span class="n">finished</span> <span class="n">coro</span><span class="o">=&lt;</span><span class="n">send_message</span><span class="p">()</span> <span class="n">done</span><span class="p">,</span> <span class="n">defined</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cryan</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">tomorrow</span><span class="o">-</span><span class="n">said</span><span class="o">-</span><span class="n">toad</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">61</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">=</span><span class="s1">&#39;7&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">&lt;</span><span class="n">Task</span> <span class="n">finished</span> <span class="n">coro</span><span class="o">=&lt;</span><span class="n">send_message</span><span class="p">()</span> <span class="n">done</span><span class="p">,</span> <span class="n">defined</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cryan</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">tomorrow</span><span class="o">-</span><span class="n">said</span><span class="o">-</span><span class="n">toad</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">61</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">=</span><span class="s1">&#39;8&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">&lt;</span><span class="n">Task</span> <span class="n">finished</span> <span class="n">coro</span><span class="o">=&lt;</span><span class="n">send_message</span><span class="p">()</span> <span class="n">done</span><span class="p">,</span> <span class="n">defined</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cryan</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">tomorrow</span><span class="o">-</span><span class="n">said</span><span class="o">-</span><span class="n">toad</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">61</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">=</span><span class="s1">&#39;9&#39;</span><span class="o">&gt;</span><span class="p">},</span>
 <span class="nb">set</span><span class="p">())</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="nb">len</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">pool</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="mi">5</span>
</pre></div>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="http://www.colmryan.org/tag/python.html">Python</a>
    </p>
  </div>





</article>

    <footer>
<p>
  &copy;  2019 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Tomorrow Said Toad ",
  "url" : "http://www.colmryan.org",
  "image": "",
  "description": ""
}
</script>

</body>
</html>