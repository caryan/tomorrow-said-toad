<!DOCTYPE html>
<html><head lang="en">
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Two approaches to Savitsky-Golay filtering - Tomorrow Said Toad</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Comparing matrix inversion and Gram polynomial approaches to Savitsky-Golay filtering." />
	<meta property="og:image" content=""/>
	<meta property="og:url" content="https://www.colmryan.org/posts/savitsky_golay/">
  <meta property="og:site_name" content="Tomorrow Said Toad">
  <meta property="og:title" content="Two approaches to Savitsky-Golay filtering">
  <meta property="og:description" content="Comparing matrix inversion and Gram polynomial approaches to Savitsky-Golay filtering.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2019-11-30T00:00:00+00:00">
    <meta property="article:modified_time" content="2020-02-27T00:00:00+00:00">
    <meta property="article:tag" content="Software">
    <meta property="article:tag" content="Julia">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Two approaches to Savitsky-Golay filtering">
  <meta name="twitter:description" content="Comparing matrix inversion and Gram polynomial approaches to Savitsky-Golay filtering.">

        <link href="https://www.colmryan.org/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://www.colmryan.org/css/main.6a0f23ea50fd34b46fee262a5a68e17d458c51a2bc99ba1ba018065de6b180c3.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="https://www.colmryan.org/css/dark.50b57e12d401420df23965fed157368aba37b76df0ecefd0b1ecd4da664f01a0.css" media="(prefers-color-scheme: dark)"  /><script type="text/javascript"
		src="https://www.colmryan.org/js/MathJax.js"></script>
		
		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			tex2jax: {
				inlineMath: [['$','$'], ['\\(','\\)']],
				displayMath: [['$$','$$'], ['\[','\]']],
				processEscapes: true,
				processEnvironments: true,
				skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
				TeX: { equationNumbers: { autoNumber: "AMS" },
						 extensions: ["AMSmath.js", "AMSsymbols.js"] }
			}
		});
		</script><link rel="stylesheet" href="https://www.colmryan.org/katex/katex.min.css ">
		<script defer src="https://www.colmryan.org/katex/katex.min.js"></script>
		<script defer src="https://www.colmryan.org/katex/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
		
		<script>
			document.addEventListener("DOMContentLoaded", function() {
					renderMathInElement(document.body, {
							delimiters: [
									{left: "$$", right: "$$", display: true},
									{left: "$", right: "$", display: false}
							]
					});
			});
		</script>
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://www.colmryan.org/">Tomorrow Said Toad</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/posts">All posts</a>
		
		<a href="/about">About</a>
		
		<a href="/tags">Tags</a>
		
		
	</nav>
</header>

<main>
  <article>
    <div class="post-container">
      
      <div class="post-content">
        <div class="title">
          <h1 class="title">Two approaches to Savitsky-Golay filtering</h1>
          <div class="meta">Posted on Nov 30, 2019</div>
        </div>
        
        <section class="body">
          <p>Savitsky-Golay filtering<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> is one of my first choices for smoothing noisy experimental data. It has the nice property of preserving higher moments of the data and so particularly for spectroscopy it preserves peak heights <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>. Savitsky-Golay filtering is a simple enough idea: fit a moving \(n^{th}\)-degree polynomial to a window around each point and then evaluate the polynomial at the mid-point to provide the smoothed value. The key insight of Savitsky-Golay was that we don&rsquo;t have to repeat the least-squares fit for every point: we can write the polynomial coefficients as a linear combination of the data values in the window so that once we know the appropriate weights we can apply the filter as a convolution.</p>
<p>I wanted to work through the usual derivation for the Savitsky-Golay convolution coefficients starting from the design matrix to make sure I understood both the pseudo-inverse approach and how <code>SciPy</code> was calculating the filter coefficients for a particular derivative with a matrix-vector least squares inversion. And I also got curious about another approach using a different family of polynomials, the Gram polynomials <sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>.</p>
<h1 id="calculating-filter-coefficients-with-matrix-inversions">Calculating filter coefficients with matrix inversions</h1>
<p>Using the conventional polynomials \(p_0 + p_1x + p_2x^2 + p_3x^3 + \dots\) we can cast the polynomial fitting problem in matrix form: \(\mathbf{A}\cdot\mathbf{p} = \mathbf{y}\) for a column vector of the polynomial coefficients, \(\mathbf{p}\) and the data in the window to fit \(\mathbf{y}\). For equally spaced normalized points \(\dots -2, -1, 0, 1, 2, \dots\) the design matrix \(\mathbf{A}\) is a <a href="https://en.wikipedia.org/wiki/Vandermonde_matrix">Vandermonde matrix</a>:</p>
$$
\begin{bmatrix}
\vdots & \vdots & \vdots & \vdots &\\
1 & -2 & 4 & -8 & \dots \\
1 & -1 & 1 & -1 & \dots \\
1 &  0 & 0 &  0 & \dots \\
1 &  1 & 1 &  1 & \dots \\
1 &  2 & 4 &  8 & \dots \\
\vdots & \vdots & \vdots & \vdots &\\
\end{bmatrix}
\begin{bmatrix}
p_0 \\
p_1 \\
p_2 \\
p_3 \\
\vdots
\end{bmatrix} =
\begin{bmatrix}
\vdots \\
y_{-2} \\
y_{-1} \\
y_0 \\
y_1 \\
y_2 \\
\vdots
\end{bmatrix}
$$<h2 id="full-pseudo-inverse">Full Pseudo-Inverse</h2>
<p>For fitting a \(m^{th}\) order polynomial to a data window \(w\) points wide we have a \(\mathbf{A}\) is a \(w \times (m+1)\) matrix and we are looking for the pseudo-inverse matrix \(\mathbf{C}\) (\((m+1) \times w\)) such that \(\mathbf{CA}\) is a \((m+1) \times (m+1)\) identity matrix and if we left multiply both sides by \(\mathbf{C}\) then we have the coefficients as a product of a matrix \(\mathbf{C}\) and the data.</p>
$$
\begin{bmatrix}
p_0 \\
p_1 \\
p_2 \\
p_3 \\
\vdots
\end{bmatrix} =
\mathbf{C}
\begin{bmatrix}
\vdots \\
y_{-2} \\
y_{-1} \\
y_0 \\
y_1 \\
y_2 \\
\vdots
\end{bmatrix}
$$<p>We are guaranteed the pseudo-inverse exists because \(w > m\) for the fit to unique and a rectangular \(w \times m\) Vandermonde matrix with all \(x_i\) unique (which we have because we have equally spaced points) has maximum rank.</p>
<p>Each row of \(\mathbf{C}\) gives the coefficients for a particular polynomial coefficient. However, for Savitsky-Golay we have a moving window and we only need to evaluate the window at the middle point where \(x=0\) and so all the \(p_i, i>0\) don&rsquo;t matter and we only need the first row. Hence we only need a single row of the matrix. Taking the \(n\)&rsquo;th derivative of the smoothed signal just shifts the coefficients with a factorial scaling and accounting for the x-point spacing. For example the 1st derivative will be \(p_1 + 2p_2x + 3p_3x^2 + \dots\) so for \(x=0\) we only need to evaluate the \(p_1\) term or the first row.</p>
<h2 id="solving-for-a-only-a-single-row-of-coefficients">Solving for a only a single row of coefficients</h2>
<p>We can take advantage of that by least-squares solving for only a single row of\(\mathbf{C}\). We&rsquo;re looking to solve \(\mathbf{CA} = \mathbf{I}\) and taking the transpose to put it in the conventional \(\mathbf{AX} = \mathbf{B}\) we have \(\mathbf{A}^\mathrm{T}\mathbf{C}^\mathrm{T} = \mathbf{I}\) or \(\mathbf{C}^\mathrm{T} = \mathbf{A}^\mathrm{T} \backslash \mathbf{I}\). We can then solve for say only the first column of $\(\mathbf{C}^\mathrm{T}\) with</p>
$$
\vec{C}_0 = \mathbf{A}^\mathrm{T} \backslash
\begin{bmatrix}
1 \\
0 \\
0 \\
0 \\
\vdots
\end{bmatrix}
$$<h1 id="calculating-filter-coefficients-with-orthogonal-polynomials">Calculating filter coefficients with orthogonal polynomials</h1>
<p>I was intrigued with a second approach using <a href="https://en.wikipedia.org/wiki/Discrete_Chebyshev_polynomials">discrete Chebyshev polynomials or Gram polynomials</a> because it promised a closed form solution <sup id="fnref1:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup> for all points in the window (as opposed to just the midpoint). This is particularly convenient at the edges. The paper provides a recursive formula for the full table of weights for every data point to evaluate the least squares fit at every point in the window. I have implemented this in the notebook but at first pass it seems rather slow and only of utility if you don&rsquo;t have access to matrix inversion routines. E.g. there appears to be a <a href="https://github.com/arntanguy/gram_savitzky_golay">C++ implementation</a>.</p>
<h1 id="corrections-to-the-original-savitsky-golay">Corrections to the original Savitsky-Golay</h1>
<p>Gorry&rsquo;s paper also pointed out a subsequent paper <sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup> that corrected many of the tables in the original Savitsky-Golay paper with the particularly harsh comment:</p>
<blockquote>
<p>The corrected values are presented in Table I. Also, Tables II, III, IV, V, and VI are corrected versions of Tables V, VII, IX, X, and XI given by Savitzky and Golay (I). They either contain more numerous errors or are systematically false.</p></blockquote>
<h1 id="julia-notebook-demo">Julia Notebook Demo</h1>
<p>I put together a little notebook demoing and benchmarking the two approaches. There are probably plenty of optimizations to be made to the Gram polynomial approach but if we have access to good matrix inversion routines then there does not seem to be any advantage to using Gram polynomials as it&rsquo;s a couple of orders of magnitude slower.</p>
<!-- raw HTML omitted -->
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>Savitzky, A., &amp; Golay, M. J. E. (1964). Smoothing and Differentiation of Data by Simplified Least Squares Procedures. <a href="https://doi.org/10.1021/ac60214a047">Analytical Chemistry, 36(8), 1627–1639</a>.&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p>Press, W. H., &amp; Teukolsky, S. A. (1990). Savitzky-Golay Smoothing Filters. <a href="https://doi.org/10.1063/1.4822961">Computers in Physics, 4(6), 669</a>.&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p>Gorry, P. A. (1990). General Least-Squares Smoothing and Differentiation by the Convolution (Savitzky-Golay) Method. <a href="https://doi.org/10.1021/ac00205a007">Analytical Chemistry, 62(6), 570–573</a>.&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a>&#160;<a href="#fnref1:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p>Steinier, J., Termonia, Y., &amp; Deltour, J. (1972). Comments on Smoothing and differentiation of data by simplified least square procedure. <a href="https://doi.org/10.1021/ac60319a045">Analytical Chemistry, 44(11), 1906–1909</a>&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

        </section>
        <div class="post-tags">
          
          
          <nav class="nav tags">
            <ul class="tags">
              
              <li><a href="/tags/software">software</a></li>
              
              <li><a href="/tags/julia">julia</a></li>
              
            </ul>
          </nav>
          
          
        </div>
      </div>

      
      
    </div>

    </article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="mailto:colm@colmryan.org" rel="me" title="Email"><svg class="feather">
   <use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#mail" />
</svg></a><a class="border"></a><a class="soc" href="https://github.com/caryan/" rel="me" title="GitHub"><svg class="feather">
   <use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#github" />
</svg></a><a class="border"></a><a class="soc" href="https://gitlab.com/caryan" rel="me" title="GitLab"><svg class="feather">
   <use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#gitlab" />
</svg></a><a class="border"></a></div>
  <div class="footer-info">
    2025  © Colm Ryan |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>



</div>
    </body>
</html>
