<!DOCTYPE html>
<html><head lang="en">
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Bitfield nicities in Python - Tomorrow Said Toad</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Using metaprogamming to make bitfields easy in Python" />
	<meta property="og:image" content=""/>
	<meta property="og:url" content="https://www.colmryan.org/posts/bitfield-nicieties-in-python/">
  <meta property="og:site_name" content="Tomorrow Said Toad">
  <meta property="og:title" content="Bitfield nicities in Python">
  <meta property="og:description" content="Using metaprogamming to make bitfields easy in Python">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2016-02-08T00:00:00+00:00">
    <meta property="article:modified_time" content="2016-02-08T00:00:00+00:00">
    <meta property="article:tag" content="Software">
    <meta property="article:tag" content="Python">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Bitfield nicities in Python">
  <meta name="twitter:description" content="Using metaprogamming to make bitfields easy in Python">

        <link href="https://www.colmryan.org/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://www.colmryan.org/css/main.6a0f23ea50fd34b46fee262a5a68e17d458c51a2bc99ba1ba018065de6b180c3.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="https://www.colmryan.org/css/dark.50b57e12d401420df23965fed157368aba37b76df0ecefd0b1ecd4da664f01a0.css" media="(prefers-color-scheme: dark)"  /><script type="text/javascript"
		src="https://www.colmryan.org/js/MathJax.js"></script>
		
		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			tex2jax: {
				inlineMath: [['$','$'], ['\\(','\\)']],
				displayMath: [['$$','$$'], ['\[','\]']],
				processEscapes: true,
				processEnvironments: true,
				skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
				TeX: { equationNumbers: { autoNumber: "AMS" },
						 extensions: ["AMSmath.js", "AMSsymbols.js"] }
			}
		});
		</script><link rel="stylesheet" href="https://www.colmryan.org/katex/katex.min.css ">
		<script defer src="https://www.colmryan.org/katex/katex.min.js"></script>
		<script defer src="https://www.colmryan.org/katex/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
		
		<script>
			document.addEventListener("DOMContentLoaded", function() {
					renderMathInElement(document.body, {
							delimiters: [
									{left: "$$", right: "$$", display: true},
									{left: "$", right: "$", display: false}
							]
					});
			});
		</script>
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://www.colmryan.org/">Tomorrow Said Toad</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/posts">All posts</a>
		
		<a href="/about">About</a>
		
		<a href="/tags">Tags</a>
		
		
	</nav>
</header>

<main>
  <article>
    <div class="post-container">
      
      <div class="post-content">
        <div class="title">
          <h1 class="title">Bitfield nicities in Python</h1>
          <div class="meta">Posted on Feb 8, 2016</div>
        </div>
        
        <section class="body">
          <p>With code contributions from <a href="http://www.grahamerowlands.com/">Graham Rowlands</a>.</p>
<p>For low level device drivers or communications protocols it&rsquo;s handy to be able
to bounce the individual bits in an integer around as several fields might be packed into a larger
integer in a <a href="https://en.wikipedia.org/wiki/Bit_field">bitfield</a>.</p>
<p>There are, of course, already several ways to tackle this in Python:</p>
<ol>
<li>Python&rsquo;s built in ctypes module already <a href="https://docs.python.org/3.5/library/ctypes.html#structures-and-unions">supports
bitfields</a>
using the <code>__fields__</code> attribute.</li>
<li>There are a number of Python modules such as <a href="http://scott-griffiths.github.io/bitstring/">bitstring</a>, <a href="https://pypi.python.org/pypi/ctypes-bitfield">ctypes-bitfield</a> or <a href="http://code.activestate.com/recipes/113799/">code examples</a></li>
</ol>
<p>But of course none of these did exactly what I wanted which a was a clean way to
define a bitfield and then use it with some error checking.</p>
<p>Fortunately some metaprogramming give a very clean interface.</p>
<h2 id="implementation">Implementation</h2>
<p>We first define class to represent the fields we want to pack.  All it has is a
width which is the width of the field in bits. All of this is for Python 3.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BitField</span>(object):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Bit field in a bit field union&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, width):
</span></span><span style="display:flex;"><span>        super(BitField, self)<span style="color:#f92672">.</span>__init__()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>width <span style="color:#f92672">=</span> width
</span></span></code></pre></div><p>Then we define a metaclass for our union of a set of bitfields and the packed
integer representation. We use a metaclass so that we can muck with the class
dictionary and parse the class variables.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BitFieldUnionMeta</span>(type):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Metaclass for injecting bitfield descriptors&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@classmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __prepare__(metacls, name, bases):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> collections<span style="color:#f92672">.</span>OrderedDict()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, name, bases, dct):
</span></span><span style="display:flex;"><span>        type<span style="color:#f92672">.</span>__init__(self, name, bases, dct)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>packed <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        init_offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> k,v <span style="color:#f92672">in</span> dct<span style="color:#f92672">.</span>items():
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> isinstance(v, BitField):
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fget</span>(self, offset<span style="color:#f92672">=</span>init_offset, width<span style="color:#f92672">=</span>v<span style="color:#f92672">.</span>width):
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> (self<span style="color:#f92672">.</span>packed <span style="color:#f92672">&gt;&gt;</span> offset) <span style="color:#f92672">&amp;</span> (<span style="color:#ae81ff">2</span><span style="color:#f92672">**</span>width<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fset</span>(self, val, offset<span style="color:#f92672">=</span>init_offset, width<span style="color:#f92672">=</span>v<span style="color:#f92672">.</span>width):
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">#check we don&#39;t exceed the width of the field</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> (val <span style="color:#f92672">&amp;</span> (<span style="color:#ae81ff">2</span><span style="color:#f92672">**</span>width<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)) <span style="color:#f92672">!=</span> val:
</span></span><span style="display:flex;"><span>                        err_msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;attempted to assign value that does not fit in bit field width </span><span style="color:#e6db74">{:d}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(width)
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(err_msg)
</span></span><span style="display:flex;"><span>                    self<span style="color:#f92672">.</span>packed <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>((<span style="color:#ae81ff">2</span><span style="color:#f92672">**</span>width<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">&lt;&lt;</span> offset) <span style="color:#75715e">#clear the field</span>
</span></span><span style="display:flex;"><span>                    self<span style="color:#f92672">.</span>packed <span style="color:#f92672">|=</span> (val <span style="color:#f92672">&amp;</span> (<span style="color:#ae81ff">2</span><span style="color:#f92672">**</span>width<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)) <span style="color:#f92672">&lt;&lt;</span> offset <span style="color:#75715e">#set the field</span>
</span></span><span style="display:flex;"><span>                setattr(self, k, property(fget, fset, <span style="color:#66d9ef">None</span>, <span style="color:#66d9ef">None</span>))
</span></span><span style="display:flex;"><span>                init_offset <span style="color:#f92672">+=</span> v<span style="color:#f92672">.</span>width
</span></span></code></pre></div><p>There is a lot going on here so let&rsquo;s go through it step by step.</p>
<ol>
<li>It&rsquo;s a metaclass so we subclass <code>type</code>.</li>
<li>We define the class <code>__prepare__</code> method (which is called during class
creation to <a href="https://docs.python.org/3/reference/datamodel.html#preparing-the-class-namespace">&ldquo;prepare the class
namespace&rdquo;</a>
or essentially the class dictionary) so that we can use an ordered dictionary.
This ensures that we pack the bits in the order in which they are defined.</li>
<li>Finally in <code>__init__</code> method, called when initializing the already instantiated metaclass, we then parse all the class variables.  If it is a BitField then we define:
<ol>
<li>a getter which slices out the appropriate bits</li>
<li>a setter which checks for overflow and then sets the appropriate slice</li>
<li>create a property for the field using the getter/setter</li>
<li>update the offset into the <code>packed</code> value - we&rsquo;re assuming an explicit ordering here to the packing.</li>
</ol>
</li>
</ol>
<p>Finally we create wrapper class to hide the metaclass and provide some keyword constructor nicities.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BitFieldUnion</span>(metaclass<span style="color:#f92672">=</span>BitFieldUnionMeta):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Painless bit packing&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, <span style="color:#f92672">**</span>kwargs):
</span></span><span style="display:flex;"><span>        super(BitFieldUnion, self)<span style="color:#f92672">.</span>__init__()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;packed&#34;</span> <span style="color:#f92672">in</span> kwargs <span style="color:#f92672">and</span> len(kwargs) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">AttributeError</span>(<span style="color:#e6db74">&#34;unable to set both `packed` and another bit field&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> k,v <span style="color:#f92672">in</span> kwargs<span style="color:#f92672">.</span>items():
</span></span><span style="display:flex;"><span>            setattr(self, k, v)
</span></span></code></pre></div><h2 id="usage">Usage</h2>
<p>Now we can play with a sample. We might have arbitrary waveform generator that plays sequences that are lists of segments.  Each 32 bit command word packed the following way:</p>
<ul>
<li>bits [15:0] segment loop count</li>
<li>bit 16 start sequence flag</li>
<li>bit 17 stop sequence flag</li>
<li>bits [21:18] sequence mode</li>
<li>bits [30:22] reserved</li>
<li>bit 31 marker enable</li>
</ul>
<p>We could create a class representing the command words as</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#ae81ff">2</span>]: <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SequenceControlWord</span>(BitFieldUnion):
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">...</span>:       segment_loop_count  <span style="color:#f92672">=</span> BitField(<span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">...</span>:       sequence_start_flag <span style="color:#f92672">=</span> BitField(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">...</span>:       sequence_stop_flag  <span style="color:#f92672">=</span> BitField(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">...</span>:       sequence_mode       <span style="color:#f92672">=</span> BitField(<span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">...</span>:       reserved            <span style="color:#f92672">=</span> BitField(<span style="color:#ae81ff">9</span>)
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">...</span>:       marker_enable       <span style="color:#f92672">=</span> BitField(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">...</span>:     
</span></span></code></pre></div><p>And use it&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#ae81ff">3</span>]: ctrl_word <span style="color:#f92672">=</span> SequenceControlWord(segment_loop_count<span style="color:#f92672">=</span><span style="color:#ae81ff">0xabc</span>, sequence_stop_flag<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, marker_enable<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">4</span>]: format(ctrl_word<span style="color:#f92672">.</span>packed, <span style="color:#e6db74">&#34;#08x&#34;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#ae81ff">4</span>]: <span style="color:#e6db74">&#39;0x80020abc&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">5</span>]: ctrl_word<span style="color:#f92672">.</span>sequence_mode <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">---------------------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ValueError</span>                                Traceback (most recent call last)
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span>ipython<span style="color:#f92672">-</span>input<span style="color:#f92672">-</span><span style="color:#ae81ff">9</span><span style="color:#f92672">-</span>a93d8ebd2cfd<span style="color:#f92672">&gt;</span> <span style="color:#f92672">in</span> <span style="color:#f92672">&lt;</span>module<span style="color:#f92672">&gt;</span>()
</span></span><span style="display:flex;"><span><span style="color:#f92672">----&gt;</span> <span style="color:#ae81ff">1</span> ctrl_word<span style="color:#f92672">.</span>sequence_mode <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">..../</span>binutils<span style="color:#f92672">.</span>py <span style="color:#f92672">in</span> fset(self, val, offset, width)
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">25</span>                     <span style="color:#66d9ef">if</span> (val <span style="color:#f92672">&amp;</span> (<span style="color:#ae81ff">2</span><span style="color:#f92672">**</span>width<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)) <span style="color:#f92672">!=</span> val:
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">26</span>                         err_msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;attempted to assign value that does not fit in bit field width </span><span style="color:#e6db74">{:d}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(width)
</span></span><span style="display:flex;"><span><span style="color:#f92672">---&gt;</span> <span style="color:#ae81ff">27</span>                         <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(err_msg)
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">28</span>                     self<span style="color:#f92672">.</span>packed <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>((<span style="color:#ae81ff">2</span><span style="color:#f92672">**</span>width<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">&lt;&lt;</span> offset) <span style="color:#75715e">#clear the field</span>
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">29</span>                     self<span style="color:#f92672">.</span>packed <span style="color:#f92672">|=</span> (val <span style="color:#f92672">&amp;</span> (<span style="color:#ae81ff">2</span><span style="color:#f92672">**</span>width<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)) <span style="color:#f92672">&lt;&lt;</span> offset <span style="color:#75715e">#set the field</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ValueError</span>: attempted to assign value that does <span style="color:#f92672">not</span> fit <span style="color:#f92672">in</span> bit field width <span style="color:#ae81ff">4</span>
</span></span></code></pre></div><h2 id="references">References</h2>
<ol>
<li><a href="http://www.dabeaz.com/py3meta/Py3Meta.pdf">Python 3 Metaprogramming</a></li>
</ol>

        </section>
        <div class="post-tags">
          
          
          <nav class="nav tags">
            <ul class="tags">
              
              <li><a href="/tags/software">software</a></li>
              
              <li><a href="/tags/python">python</a></li>
              
            </ul>
          </nav>
          
          
        </div>
      </div>

      
      
    </div>

    </article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="mailto:colm@colmryan.org" rel="me" title="Email"><svg class="feather">
   <use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#mail" />
</svg></a><a class="border"></a><a class="soc" href="https://github.com/caryan/" rel="me" title="GitHub"><svg class="feather">
   <use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#github" />
</svg></a><a class="border"></a><a class="soc" href="https://gitlab.com/caryan" rel="me" title="GitLab"><svg class="feather">
   <use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#gitlab" />
</svg></a><a class="border"></a></div>
  <div class="footer-info">
    2025  © Colm Ryan |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>



</div>
    </body>
</html>
