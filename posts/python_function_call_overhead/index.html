<!DOCTYPE html>
<html><head lang="en">
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Python function call overhead - Tomorrow Said Toad</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Measuring function call overhead from Python 2.7 to 3.8" />
	<meta property="og:image" content=""/>
	<meta property="og:url" content="https://www.colmryan.org/posts/python_function_call_overhead/">
  <meta property="og:site_name" content="Tomorrow Said Toad">
  <meta property="og:title" content="Python function call overhead">
  <meta property="og:description" content="Measuring function call overhead from Python 2.7 to 3.8">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-06-17T00:00:00+00:00">
    <meta property="article:modified_time" content="2020-06-17T00:00:00+00:00">
    <meta property="article:tag" content="Software">
    <meta property="article:tag" content="Python">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Python function call overhead">
  <meta name="twitter:description" content="Measuring function call overhead from Python 2.7 to 3.8">

        <link href="https://www.colmryan.org/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://www.colmryan.org/css/main.6a0f23ea50fd34b46fee262a5a68e17d458c51a2bc99ba1ba018065de6b180c3.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="https://www.colmryan.org/css/dark.50b57e12d401420df23965fed157368aba37b76df0ecefd0b1ecd4da664f01a0.css" media="(prefers-color-scheme: dark)"  /><script type="text/javascript"
		src="https://www.colmryan.org/js/MathJax.js"></script>
		
		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			tex2jax: {
				inlineMath: [['$','$'], ['\\(','\\)']],
				displayMath: [['$$','$$'], ['\[','\]']],
				processEscapes: true,
				processEnvironments: true,
				skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
				TeX: { equationNumbers: { autoNumber: "AMS" },
						 extensions: ["AMSmath.js", "AMSsymbols.js"] }
			}
		});
		</script><link rel="stylesheet" href="https://www.colmryan.org/katex/katex.min.css ">
		<script defer src="https://www.colmryan.org/katex/katex.min.js"></script>
		<script defer src="https://www.colmryan.org/katex/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
		
		<script>
			document.addEventListener("DOMContentLoaded", function() {
					renderMathInElement(document.body, {
							delimiters: [
									{left: "$$", right: "$$", display: true},
									{left: "$", right: "$", display: false}
							]
					});
			});
		</script>
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://www.colmryan.org/">Tomorrow Said Toad</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/posts">All posts</a>
		
		<a href="/about">About</a>
		
		<a href="/tags">Tags</a>
		
		
	</nav>
</header>

<main>
  <article>
    <div class="post-container">
      
      <div class="post-content">
        <div class="title">
          <h1 class="title">Python function call overhead</h1>
          <div class="meta">Posted on Jun 17, 2020</div>
        </div>
        
        <section class="body">
          <p>Wrapping some piece of logic in a function provides all the promised benefits: code reuse, scope isolation, unit-testing boundary, etc. However, as always, there are no unalloyed goods and I&rsquo;m particularly partial to Cindy Sridharan&rsquo;s <a href="https://medium.com/@copyconstruct/small-functions-considered-harmful-91035d316c29">Small Functions considered Harmful</a> take on the harms of taking this too far. There is also a non-zero performance penalty where there is no optimizing compiler to inline function calls and out of curiosity I wanted to look at what this performance penalty is for Python by trying to measure the overhead of Python functions.</p>
<p>I am quite sure there are some benchmarking boobytraps I&rsquo;m missing, but the approach I took to measure function call overhead was to make a series of increasingly nested function calls and then time how long each one took. For example, if we define</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">a</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">29</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">b</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> a()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">c</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> b()
</span></span></code></pre></div><p>then by timing how much longer <code>b()</code> takes than <code>a()</code> and <code>c()</code> than <code>b()</code> and so on then can attribute that increase to function call overhead</p>
<p>We can then repeat the pattern of nested function calls for a few different types of functions:</p>
<ol>
<li>Plain no-argument functions (as above).</li>
<li>1 argument functions to see how expensive passing arguments is.</li>
<li>Instance methods with no arguments to check the overhead of adding classes to the mix.</li>
<li>Instance methods with 1 argument.</li>
</ol>
<p>The code for the remaining cases looks something like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">times2_a</span>(x):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>x
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">times2_b</span>(x):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> times2_a(x)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">times2_c</span>(x):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> times2_b(x)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OneLiners</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">a</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">29</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">b</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>a()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">c</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>b()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">times2_a</span>(self, x):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>x
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">times2_b</span>(self, x):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>times2_a(x)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">times2_c</span>(self, x):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>times2_b(x)
</span></span></code></pre></div><p>We can then time everything using <a href="https://ipython.readthedocs.io/en/stable/interactive/magics.html#magic-timeit">iPython&rsquo;s <code>timeit</code> magic</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>timing_results <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>timing_results[<span style="color:#e6db74">&#39;Function No Arg&#39;</span>] <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ti <span style="color:#f92672">=</span> <span style="color:#f92672">%</span>timeit <span style="color:#f92672">-</span>o <span style="color:#f92672">-</span>q a()
</span></span><span style="display:flex;"><span>timing_results[<span style="color:#e6db74">&#39;Function No Arg&#39;</span>]<span style="color:#f92672">.</span>append(ti)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ti <span style="color:#f92672">=</span> <span style="color:#f92672">%</span>timeit <span style="color:#f92672">-</span>o <span style="color:#f92672">-</span>q b()
</span></span><span style="display:flex;"><span>timing_results[<span style="color:#e6db74">&#39;Function No Arg&#39;</span>]<span style="color:#f92672">.</span>append(ti)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">⋮</span>
</span></span></code></pre></div><p>And plot the timing results as function time versus function depth (up to 10) and run some simple linear regression to estimate the slope in order to extract the overhead per function call assuming it is constant with stack size.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>fig,ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">6</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>overheads <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>max_depth <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># explicit order because dictionary order is only preserved for Python 3.6+</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ct, label <span style="color:#f92672">in</span> enumerate((<span style="color:#e6db74">&#39;Function No Arg&#39;</span>, <span style="color:#e6db74">&#39;Function 1 Arg&#39;</span>, <span style="color:#e6db74">&#39;Class Method No Arg&#39;</span>, <span style="color:#e6db74">&#39;Class Method 1 Arg&#39;</span>)):
</span></span><span style="display:flex;"><span>    results <span style="color:#f92672">=</span> timing_results[label]
</span></span><span style="display:flex;"><span>    xs <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> np<span style="color:#f92672">.</span>arange(max_depth)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># the results from timeit changed at some point</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     vals = np.array([ti.average/1e-9 for ti in results])</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     errs = np.array([ti.stdev/1e-9 for ti in results])</span>
</span></span><span style="display:flex;"><span>    vals <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array([np<span style="color:#f92672">.</span>mean(ti<span style="color:#f92672">.</span>all_runs)<span style="color:#f92672">/</span>ti<span style="color:#f92672">.</span>loops<span style="color:#f92672">/</span><span style="color:#ae81ff">1e-9</span> <span style="color:#66d9ef">for</span> ti <span style="color:#f92672">in</span> results])
</span></span><span style="display:flex;"><span>    errs <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array([np<span style="color:#f92672">.</span>std(ti<span style="color:#f92672">.</span>all_runs)<span style="color:#f92672">/</span>ti<span style="color:#f92672">.</span>loops<span style="color:#f92672">/</span><span style="color:#ae81ff">1e-9</span> <span style="color:#66d9ef">for</span> ti <span style="color:#f92672">in</span> results])
</span></span><span style="display:flex;"><span>    fit_coeffs, V <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>polyfit(xs, vals, deg<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, cov<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, w<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>errs)
</span></span><span style="display:flex;"><span>    overheads[label] <span style="color:#f92672">=</span> (fit_coeffs[<span style="color:#ae81ff">0</span>], np<span style="color:#f92672">.</span>sqrt(V[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>]))
</span></span><span style="display:flex;"><span>    err_bars <span style="color:#f92672">=</span> ax<span style="color:#f92672">.</span>errorbar(xs, vals, yerr<span style="color:#f92672">=</span>errs, linestyle<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;none&#34;</span>, elinewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, marker<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;.&#34;</span>, label<span style="color:#f92672">=</span>label<span style="color:#f92672">+</span><span style="color:#e6db74">&#34; | </span><span style="color:#e6db74">{:.0f}</span><span style="color:#e6db74"> +- </span><span style="color:#e6db74">{:.0f}</span><span style="color:#e6db74"> ns&#34;</span><span style="color:#f92672">.</span>format(overheads[label][<span style="color:#ae81ff">0</span>],overheads[label][<span style="color:#ae81ff">1</span>]), color<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;C</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(ct))
</span></span><span style="display:flex;"><span>    ax<span style="color:#f92672">.</span>plot(xs, np<span style="color:#f92672">.</span>poly1d(fit_coeffs)(xs))
</span></span><span style="display:flex;"><span>    ax<span style="color:#f92672">.</span>set_xlabel(<span style="color:#e6db74">&#34;Function Depth&#34;</span>)
</span></span><span style="display:flex;"><span>    ax<span style="color:#f92672">.</span>set_ylabel(<span style="color:#e6db74">&#34;Overhead (ns)&#34;</span>)
</span></span><span style="display:flex;"><span>    ax<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">&#34;Function Call Overhead in Python </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(platform<span style="color:#f92672">.</span>python_version()))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>legend(loc<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;upper center&#34;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>savefig(<span style="color:#e6db74">&#34;function_call_overheads_</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">.svg&#34;</span><span style="color:#f92672">.</span>format(platform<span style="color:#f92672">.</span>python_version()))
</span></span></code></pre></div><p>We get typical plots like below for Python 3.8. There are some outliers with large uncertainty which I attribute to not being careful about making sure there was nothing else going on. The results are not as linear as I expected. Particularly for the &ldquo;Function No Arg&rdquo; case there seems to be a step around a depth of 5 and the error bars are inconsistent with the linear model. Nevertheless, the approach gives reproducible results over multiple runs.</p>
<figure><img src="/posts/python_function_call_overhead/function_call_overheads_3.8.3.svg" width="100%">
</figure>

<p>The results consistently show a function call overhead in the 50-100 ns range and increasing overhead with either function arguments or using class methods. If some code is only making a few function calls and trying to perform logic on a human timescale of many 10&rsquo;s of ms then this overhead of 10&rsquo;s of nanoseconds is probably immaterial. However, if you&rsquo;re applying some small function to many millions of array elements then this overhead is very material. Of course going fast in array processing in Python is all about avoiding this penalty and calling out to C via e.g. <code>numpy</code>.</p>
<p>Finally we can rerun this overhead analysis for several recent versions of Python 3 and Python 2.7 to see how the optimizations made have changed the situation. Bundling the results by either function type or Python version we see:</p>
<figure><img src="/posts/python_function_call_overhead/function_call_overhead_grouped_by_type.svg" width="100%">
</figure>

<figure><img src="/posts/python_function_call_overhead/function_call_overhead_grouped_by_version.svg" width="100%">
</figure>

<p>The overall picture is that the gap between bare functions and class methods appears to being squeezed out. Presumably the big improvement from Python 3.6 to 3.7 came from specific <a href="https://docs.python.org/3/whatsnew/3.7.html#optimizations">optimizations</a></p>
<blockquote>
<p>Method calls are now up to 20% faster due to the bytecode changes which avoid creating bound method instances.</p></blockquote>
<p>The entire notebook is available on <a href="https://nbviewer.jupyter.org/gist/caryan/4a2c94a62e9da5b18eaed62fb637fc4a">nbviewer</a></p>

        </section>
        <div class="post-tags">
          
          
          <nav class="nav tags">
            <ul class="tags">
              
              <li><a href="/tags/software">software</a></li>
              
              <li><a href="/tags/python">python</a></li>
              
            </ul>
          </nav>
          
          
        </div>
      </div>

      
      
    </div>

    </article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="mailto:colm@colmryan.org" rel="me" title="Email"><svg class="feather">
   <use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#mail" />
</svg></a><a class="border"></a><a class="soc" href="https://github.com/caryan/" rel="me" title="GitHub"><svg class="feather">
   <use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#github" />
</svg></a><a class="border"></a><a class="soc" href="https://gitlab.com/caryan" rel="me" title="GitLab"><svg class="feather">
   <use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#gitlab" />
</svg></a><a class="border"></a></div>
  <div class="footer-info">
    2025  © Colm Ryan |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>



</div>
    </body>
</html>
