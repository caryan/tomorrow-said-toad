<!DOCTYPE html>
<html><head lang="en">
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Asyncio Socket Pool - Tomorrow Said Toad</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="A socket pool with Python&rsquo;s asyncio" />
	<meta property="og:image" content=""/>
	<meta property="og:url" content="https://www.colmryan.org/posts/asyncio-socket-pool/">
  <meta property="og:site_name" content="Tomorrow Said Toad">
  <meta property="og:title" content="Asyncio Socket Pool">
  <meta property="og:description" content="A socket pool with Python’s asyncio">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2019-08-12T00:00:00+00:00">
    <meta property="article:modified_time" content="2019-08-12T00:00:00+00:00">
    <meta property="article:tag" content="Software">
    <meta property="article:tag" content="Python">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Asyncio Socket Pool">
  <meta name="twitter:description" content="A socket pool with Python’s asyncio">

        <link href="https://www.colmryan.org/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://www.colmryan.org/css/main.6a0f23ea50fd34b46fee262a5a68e17d458c51a2bc99ba1ba018065de6b180c3.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="https://www.colmryan.org/css/dark.50b57e12d401420df23965fed157368aba37b76df0ecefd0b1ecd4da664f01a0.css" media="(prefers-color-scheme: dark)"  /><script type="text/javascript"
		src="https://www.colmryan.org/js/MathJax.js"></script>
		
		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			tex2jax: {
				inlineMath: [['$','$'], ['\\(','\\)']],
				displayMath: [['$$','$$'], ['\[','\]']],
				processEscapes: true,
				processEnvironments: true,
				skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
				TeX: { equationNumbers: { autoNumber: "AMS" },
						 extensions: ["AMSmath.js", "AMSsymbols.js"] }
			}
		});
		</script><link rel="stylesheet" href="https://www.colmryan.org/katex/katex.min.css ">
		<script defer src="https://www.colmryan.org/katex/katex.min.js"></script>
		<script defer src="https://www.colmryan.org/katex/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
		
		<script>
			document.addEventListener("DOMContentLoaded", function() {
					renderMathInElement(document.body, {
							delimiters: [
									{left: "$$", right: "$$", display: true},
									{left: "$", right: "$", display: false}
							]
					});
			});
		</script>
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://www.colmryan.org/">Tomorrow Said Toad</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/posts">All posts</a>
		
		<a href="/about">About</a>
		
		<a href="/tags">Tags</a>
		
		
	</nav>
</header>

<main>
  <article>
    <div class="post-container">
      
      <div class="post-content">
        <div class="title">
          <h1 class="title">Asyncio Socket Pool</h1>
          <div class="meta">Posted on Aug 12, 2019</div>
        </div>
        
        <section class="body">
          <p>In a typical client-server over a socket setup the server may take some time to process any given
request and so to allow thee client to fire off multiple requests in parallel to speed things up
there are two common paths:</p>
<ol>
<li>We can make the server interface asynchronous so that it is able to take a whole series of
requests and respond to them out of order.</li>
<li>The server can support multiple socket connections, but each one is
blocking and so we can parallelize communications across the multiple sockets.</li>
</ol>
<p>The first is more elegant but requires additional work to allow the server to asynchronously
dispatch requests and keep responding to new ones and for the client to handle the out of order
replies. We took that path with the <a href="https://github.com/rigetti/rpcq/tree/master/rpcq">rpcq
client-server</a> For simpler cases, multiple sockets
might be sufficient.</p>
<p>Here is a simple implementation of a client socket pool wrapped an an <a href="https://docs.python.org/3/library/contextlib.html#contextlib.asynccontextmanager">asynccontextmanager
decorator</a> so that
we can nicely <code>async with ...</code> <code>await</code> on the next available socket. To bound the number of sockets
we use an <a href="https://docs.python.org/3/library/asyncio-sync.html#asyncio.Semaphore">asyncio
Semaphore</a>. The semaphore is
an integer that is initialized to the maximum number of sockets. Every time a socket is checked out
from the pool we <code>await</code> on the semaphore, the integer is decremented by one and then finally the
semaphore blocks when the integer would go negative. When we are done with the socket we return it
to the pool and increment the semaphore integer again. All this integer decrement/increment logic is
wrapped with by the Python <code>asyncio</code> module with another <code>asynccontextmanager</code> so all the
bookkeeping so the interface is a simple <code>async with self.semaphore:</code>. We&rsquo;ll return the high-level
<code>asyncio StreamReader/StreamWriter</code> to provide access to the socket.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> contextlib <span style="color:#f92672">import</span> asynccontextmanager
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Optional, Tuple
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SocketPool</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    A pool of socket connections for a client to access some server.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    address: str
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34; Hostname for the server &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    port: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">1234</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34; Port that the instrument is listening for connections on. &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    max_num_sockets: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34; Maximum number of open sockets to the server &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    semaphore: asyncio<span style="color:#f92672">.</span>Semaphore
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34; Use a semaphore to bound the number of open connection to `max_num_sockets` &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pool: list
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34; List of socket StreamReader, StreamWriter pairs &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, address: str, max_num_sockets: Optional[int] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>, port: Optional[int] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>address <span style="color:#f92672">=</span> address
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># if we&#39;re passed some `max_num_sockets` or `port` then override the defaults</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> max_num_sockets <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>max_num_sockets <span style="color:#f92672">=</span> max_num_sockets
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> port <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>port <span style="color:#f92672">=</span> port
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>semaphore <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>Semaphore(self<span style="color:#f92672">.</span>max_num_sockets)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># a list to hold onto the (asyncio.StreamReader, asyncio.StreamWriter) tuples for each socket</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>pool <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@asynccontextmanager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_socket</span>(self) <span style="color:#f92672">-&gt;</span> Tuple[asyncio<span style="color:#f92672">.</span>StreamReader, asyncio<span style="color:#f92672">.</span>StreamWriter]:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        Get the next available socket reader/writer from the pool
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> self<span style="color:#f92672">.</span>semaphore:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># take the last socket in the pool</span>
</span></span><span style="display:flex;"><span>                reader, writer <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>pool<span style="color:#f92672">.</span>pop()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">IndexError</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># empty list so create a new socket</span>
</span></span><span style="display:flex;"><span>                _log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Adding socket connection to server at </span><span style="color:#e6db74">{</span>self<span style="color:#f92672">.</span>address<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>                reader, writer <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>open_connection(self<span style="color:#f92672">.</span>address, self<span style="color:#f92672">.</span>port)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># hand the reader/writer pair back to the caller</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">yield</span> reader, writer
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">finally</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># put the socket back in the pool</span>
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>pool<span style="color:#f92672">.</span>append((reader, writer))
</span></span></code></pre></div><p>We can then test this out with a simple echo server that listens for connections and then takes some
time to respond.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handle_echo</span>(reader, writer):
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> reader<span style="color:#f92672">.</span>read(<span style="color:#ae81ff">100</span>)
</span></span><span style="display:flex;"><span>    message <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>decode()
</span></span><span style="display:flex;"><span>    addr <span style="color:#f92672">=</span> writer<span style="color:#f92672">.</span>get_extra_info(<span style="color:#e6db74">&#39;peername&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Received </span><span style="color:#e6db74">{</span>message<span style="color:#e6db74">!r}</span><span style="color:#e6db74"> from </span><span style="color:#e6db74">{</span>addr<span style="color:#e6db74">!r}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Taking a second to process something....&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1.0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Sending back response.&#34;</span>)
</span></span><span style="display:flex;"><span>    writer<span style="color:#f92672">.</span>write(data)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> writer<span style="color:#f92672">.</span>drain()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Close the connection&#34;</span>)
</span></span><span style="display:flex;"><span>    writer<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>    server <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>start_server(handle_echo, <span style="color:#e6db74">&#34;localhost&#34;</span>, <span style="color:#ae81ff">1234</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    addr <span style="color:#f92672">=</span> server<span style="color:#f92672">.</span>sockets[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>getsockname()
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Serving on </span><span style="color:#e6db74">{</span>addr<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> server:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> server<span style="color:#f92672">.</span>serve_forever()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><p>And then a simple client side function to use it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> wherever.socket_pool <span style="color:#f92672">import</span> SocketPool
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_message</span>(pool, msg):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># check out a socket</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> pool<span style="color:#f92672">.</span>get_socket() <span style="color:#66d9ef">as</span> (reader, writer):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># send the message</span>
</span></span><span style="display:flex;"><span>        writer<span style="color:#f92672">.</span>write(msg<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> writer<span style="color:#f92672">.</span>drain()
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># wait for the echo response</span>
</span></span><span style="display:flex;"><span>        resp <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> reader<span style="color:#f92672">.</span>read(<span style="color:#ae81ff">100</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> resp<span style="color:#f92672">.</span>decode()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pool <span style="color:#f92672">=</span> SocketPool(<span style="color:#e6db74">&#34;localhost&#34;</span> max_num_sockets<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>(base) cryan<span style="color:#a6e22e">@cryan</span><span style="color:#f92672">-</span>Precision<span style="color:#f92672">-</span><span style="color:#ae81ff">5510</span>:<span style="color:#f92672">~/</span>repos<span style="color:#f92672">/</span>tomorrow<span style="color:#f92672">-</span>said<span style="color:#f92672">-</span>toad<span style="color:#f92672">/</span>content<span style="color:#960050;background-color:#1e0010">$</span> ipython
</span></span><span style="display:flex;"><span>Python <span style="color:#ae81ff">3.7.4</span> (default, Aug <span style="color:#ae81ff">13</span> <span style="color:#ae81ff">2019</span>, <span style="color:#ae81ff">20</span>:<span style="color:#ae81ff">35</span>:<span style="color:#ae81ff">49</span>)
</span></span><span style="display:flex;"><span>Type <span style="color:#e6db74">&#39;copyright&#39;</span>, <span style="color:#e6db74">&#39;credits&#39;</span> <span style="color:#f92672">or</span> <span style="color:#e6db74">&#39;license&#39;</span> <span style="color:#66d9ef">for</span> more information
</span></span><span style="display:flex;"><span>IPython <span style="color:#ae81ff">7.8.0</span> <span style="color:#f92672">--</span> An enhanced Interactive Python<span style="color:#f92672">.</span> Type <span style="color:#e6db74">&#39;?&#39;</span> <span style="color:#66d9ef">for</span> help<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">1</span>]: <span style="color:#f92672">%</span>paste <span style="color:#75715e"># import the client code</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># send a single message and a single socket is created</span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">2</span>]: <span style="color:#66d9ef">await</span> send_message(pool, <span style="color:#e6db74">&#34;Hello!&#34;</span>)
</span></span><span style="display:flex;"><span>Adding socket connection to server at localhost
</span></span><span style="display:flex;"><span>Out[<span style="color:#ae81ff">2</span>]: <span style="color:#e6db74">&#39;Hello!&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># we can inspect the pool and see indeed there is one socket there</span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">3</span>]: pool<span style="color:#f92672">.</span>pool
</span></span><span style="display:flex;"><span>Out[<span style="color:#ae81ff">3</span>]:
</span></span><span style="display:flex;"><span>[(<span style="color:#f92672">&lt;</span>StreamReader transport<span style="color:#f92672">=&lt;</span>_SelectorSocketTransport fd<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span> read<span style="color:#f92672">=</span>polling write<span style="color:#f92672">=&lt;</span>idle, bufsize<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span>StreamWriter transport<span style="color:#f92672">=&lt;</span>_SelectorSocketTransport fd<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span> read<span style="color:#f92672">=</span>polling write<span style="color:#f92672">=&lt;</span>idle, bufsize<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;&gt;</span> reader<span style="color:#f92672">=&lt;</span>StreamReader transport<span style="color:#f92672">=&lt;</span>_SelectorSocketTransport fd<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span> read<span style="color:#f92672">=</span>polling write<span style="color:#f92672">=&lt;</span>idle, bufsize<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;&gt;&gt;&gt;</span>)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">4</span>]: len(pool<span style="color:#f92672">.</span>pool)
</span></span><span style="display:flex;"><span>Out[<span style="color:#ae81ff">4</span>]: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># now send a slew of requests at once and it still takes only a second to respond</span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">5</span>]: <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>wait([send_message(pool, str(ct)) <span style="color:#66d9ef">for</span> ct <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">5</span>)])
</span></span><span style="display:flex;"><span>Adding socket connection to server at localhost
</span></span><span style="display:flex;"><span>Adding socket connection to server at localhost
</span></span><span style="display:flex;"><span>Adding socket connection to server at localhost
</span></span><span style="display:flex;"><span>Adding socket connection to server at localhost
</span></span><span style="display:flex;"><span>Out[<span style="color:#ae81ff">5</span>]:
</span></span><span style="display:flex;"><span>({<span style="color:#f92672">&lt;</span>Task finished coro<span style="color:#f92672">=&lt;</span>send_message() done, defined at <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>cryan<span style="color:#f92672">/</span>repos<span style="color:#f92672">/</span>tomorrow<span style="color:#f92672">-</span>said<span style="color:#f92672">-</span>toad<span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>client<span style="color:#f92672">.</span>py:<span style="color:#ae81ff">61</span><span style="color:#f92672">&gt;</span> result<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;0&#39;</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span>Task finished coro<span style="color:#f92672">=&lt;</span>send_message() done, defined at <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>cryan<span style="color:#f92672">/</span>repos<span style="color:#f92672">/</span>tomorrow<span style="color:#f92672">-</span>said<span style="color:#f92672">-</span>toad<span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>client<span style="color:#f92672">.</span>py:<span style="color:#ae81ff">61</span><span style="color:#f92672">&gt;</span> result<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;1&#39;</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span>Task finished coro<span style="color:#f92672">=&lt;</span>send_message() done, defined at <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>cryan<span style="color:#f92672">/</span>repos<span style="color:#f92672">/</span>tomorrow<span style="color:#f92672">-</span>said<span style="color:#f92672">-</span>toad<span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>client<span style="color:#f92672">.</span>py:<span style="color:#ae81ff">61</span><span style="color:#f92672">&gt;</span> result<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;2&#39;</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span>Task finished coro<span style="color:#f92672">=&lt;</span>send_message() done, defined at <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>cryan<span style="color:#f92672">/</span>repos<span style="color:#f92672">/</span>tomorrow<span style="color:#f92672">-</span>said<span style="color:#f92672">-</span>toad<span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>client<span style="color:#f92672">.</span>py:<span style="color:#ae81ff">61</span><span style="color:#f92672">&gt;</span> result<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;3&#39;</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span>Task finished coro<span style="color:#f92672">=&lt;</span>send_message() done, defined at <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>cryan<span style="color:#f92672">/</span>repos<span style="color:#f92672">/</span>tomorrow<span style="color:#f92672">-</span>said<span style="color:#f92672">-</span>toad<span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>client<span style="color:#f92672">.</span>py:<span style="color:#ae81ff">61</span><span style="color:#f92672">&gt;</span> result<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;4&#39;</span><span style="color:#f92672">&gt;</span>},
</span></span><span style="display:flex;"><span> set())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># and we have 5 sockets in the pool</span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">6</span>]: len(pool<span style="color:#f92672">.</span>pool)
</span></span><span style="display:flex;"><span>Out[<span style="color:#ae81ff">6</span>]: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># finally send even more requests and it takes about 4 seconds to respond as only 5 requests are outstanding at any time</span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">7</span>]: <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>wait([send_message(pool, str(ct)) <span style="color:#66d9ef">for</span> ct <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">20</span>)])
</span></span><span style="display:flex;"><span>Out[<span style="color:#ae81ff">7</span>]:
</span></span><span style="display:flex;"><span>({<span style="color:#f92672">&lt;</span>Task finished coro<span style="color:#f92672">=&lt;</span>send_message() done, defined at <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>cryan<span style="color:#f92672">/</span>repos<span style="color:#f92672">/</span>tomorrow<span style="color:#f92672">-</span>said<span style="color:#f92672">-</span>toad<span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>client<span style="color:#f92672">.</span>py:<span style="color:#ae81ff">61</span><span style="color:#f92672">&gt;</span> result<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;0&#39;</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span>Task finished coro<span style="color:#f92672">=&lt;</span>send_message() done, defined at <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>cryan<span style="color:#f92672">/</span>repos<span style="color:#f92672">/</span>tomorrow<span style="color:#f92672">-</span>said<span style="color:#f92672">-</span>toad<span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>client<span style="color:#f92672">.</span>py:<span style="color:#ae81ff">61</span><span style="color:#f92672">&gt;</span> result<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;1&#39;</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span>Task finished coro<span style="color:#f92672">=&lt;</span>send_message() done, defined at <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>cryan<span style="color:#f92672">/</span>repos<span style="color:#f92672">/</span>tomorrow<span style="color:#f92672">-</span>said<span style="color:#f92672">-</span>toad<span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>client<span style="color:#f92672">.</span>py:<span style="color:#ae81ff">61</span><span style="color:#f92672">&gt;</span> result<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;10&#39;</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span>Task finished coro<span style="color:#f92672">=&lt;</span>send_message() done, defined at <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>cryan<span style="color:#f92672">/</span>repos<span style="color:#f92672">/</span>tomorrow<span style="color:#f92672">-</span>said<span style="color:#f92672">-</span>toad<span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>client<span style="color:#f92672">.</span>py:<span style="color:#ae81ff">61</span><span style="color:#f92672">&gt;</span> result<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;11&#39;</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span>Task finished coro<span style="color:#f92672">=&lt;</span>send_message() done, defined at <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>cryan<span style="color:#f92672">/</span>repos<span style="color:#f92672">/</span>tomorrow<span style="color:#f92672">-</span>said<span style="color:#f92672">-</span>toad<span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>client<span style="color:#f92672">.</span>py:<span style="color:#ae81ff">61</span><span style="color:#f92672">&gt;</span> result<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;12&#39;</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span>Task finished coro<span style="color:#f92672">=&lt;</span>send_message() done, defined at <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>cryan<span style="color:#f92672">/</span>repos<span style="color:#f92672">/</span>tomorrow<span style="color:#f92672">-</span>said<span style="color:#f92672">-</span>toad<span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>client<span style="color:#f92672">.</span>py:<span style="color:#ae81ff">61</span><span style="color:#f92672">&gt;</span> result<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;13&#39;</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span>Task finished coro<span style="color:#f92672">=&lt;</span>send_message() done, defined at <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>cryan<span style="color:#f92672">/</span>repos<span style="color:#f92672">/</span>tomorrow<span style="color:#f92672">-</span>said<span style="color:#f92672">-</span>toad<span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>client<span style="color:#f92672">.</span>py:<span style="color:#ae81ff">61</span><span style="color:#f92672">&gt;</span> result<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;14&#39;</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span>Task finished coro<span style="color:#f92672">=&lt;</span>send_message() done, defined at <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>cryan<span style="color:#f92672">/</span>repos<span style="color:#f92672">/</span>tomorrow<span style="color:#f92672">-</span>said<span style="color:#f92672">-</span>toad<span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>client<span style="color:#f92672">.</span>py:<span style="color:#ae81ff">61</span><span style="color:#f92672">&gt;</span> result<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;15&#39;</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span>Task finished coro<span style="color:#f92672">=&lt;</span>send_message() done, defined at <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>cryan<span style="color:#f92672">/</span>repos<span style="color:#f92672">/</span>tomorrow<span style="color:#f92672">-</span>said<span style="color:#f92672">-</span>toad<span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>client<span style="color:#f92672">.</span>py:<span style="color:#ae81ff">61</span><span style="color:#f92672">&gt;</span> result<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;16&#39;</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span>Task finished coro<span style="color:#f92672">=&lt;</span>send_message() done, defined at <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>cryan<span style="color:#f92672">/</span>repos<span style="color:#f92672">/</span>tomorrow<span style="color:#f92672">-</span>said<span style="color:#f92672">-</span>toad<span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>client<span style="color:#f92672">.</span>py:<span style="color:#ae81ff">61</span><span style="color:#f92672">&gt;</span> result<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;17&#39;</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span>Task finished coro<span style="color:#f92672">=&lt;</span>send_message() done, defined at <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>cryan<span style="color:#f92672">/</span>repos<span style="color:#f92672">/</span>tomorrow<span style="color:#f92672">-</span>said<span style="color:#f92672">-</span>toad<span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>client<span style="color:#f92672">.</span>py:<span style="color:#ae81ff">61</span><span style="color:#f92672">&gt;</span> result<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;18&#39;</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span>Task finished coro<span style="color:#f92672">=&lt;</span>send_message() done, defined at <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>cryan<span style="color:#f92672">/</span>repos<span style="color:#f92672">/</span>tomorrow<span style="color:#f92672">-</span>said<span style="color:#f92672">-</span>toad<span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>client<span style="color:#f92672">.</span>py:<span style="color:#ae81ff">61</span><span style="color:#f92672">&gt;</span> result<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;19&#39;</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span>Task finished coro<span style="color:#f92672">=&lt;</span>send_message() done, defined at <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>cryan<span style="color:#f92672">/</span>repos<span style="color:#f92672">/</span>tomorrow<span style="color:#f92672">-</span>said<span style="color:#f92672">-</span>toad<span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>client<span style="color:#f92672">.</span>py:<span style="color:#ae81ff">61</span><span style="color:#f92672">&gt;</span> result<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;2&#39;</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span>Task finished coro<span style="color:#f92672">=&lt;</span>send_message() done, defined at <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>cryan<span style="color:#f92672">/</span>repos<span style="color:#f92672">/</span>tomorrow<span style="color:#f92672">-</span>said<span style="color:#f92672">-</span>toad<span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>client<span style="color:#f92672">.</span>py:<span style="color:#ae81ff">61</span><span style="color:#f92672">&gt;</span> result<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;3&#39;</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span>Task finished coro<span style="color:#f92672">=&lt;</span>send_message() done, defined at <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>cryan<span style="color:#f92672">/</span>repos<span style="color:#f92672">/</span>tomorrow<span style="color:#f92672">-</span>said<span style="color:#f92672">-</span>toad<span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>client<span style="color:#f92672">.</span>py:<span style="color:#ae81ff">61</span><span style="color:#f92672">&gt;</span> result<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;4&#39;</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span>Task finished coro<span style="color:#f92672">=&lt;</span>send_message() done, defined at <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>cryan<span style="color:#f92672">/</span>repos<span style="color:#f92672">/</span>tomorrow<span style="color:#f92672">-</span>said<span style="color:#f92672">-</span>toad<span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>client<span style="color:#f92672">.</span>py:<span style="color:#ae81ff">61</span><span style="color:#f92672">&gt;</span> result<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;5&#39;</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span>Task finished coro<span style="color:#f92672">=&lt;</span>send_message() done, defined at <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>cryan<span style="color:#f92672">/</span>repos<span style="color:#f92672">/</span>tomorrow<span style="color:#f92672">-</span>said<span style="color:#f92672">-</span>toad<span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>client<span style="color:#f92672">.</span>py:<span style="color:#ae81ff">61</span><span style="color:#f92672">&gt;</span> result<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;6&#39;</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span>Task finished coro<span style="color:#f92672">=&lt;</span>send_message() done, defined at <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>cryan<span style="color:#f92672">/</span>repos<span style="color:#f92672">/</span>tomorrow<span style="color:#f92672">-</span>said<span style="color:#f92672">-</span>toad<span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>client<span style="color:#f92672">.</span>py:<span style="color:#ae81ff">61</span><span style="color:#f92672">&gt;</span> result<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;7&#39;</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span>Task finished coro<span style="color:#f92672">=&lt;</span>send_message() done, defined at <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>cryan<span style="color:#f92672">/</span>repos<span style="color:#f92672">/</span>tomorrow<span style="color:#f92672">-</span>said<span style="color:#f92672">-</span>toad<span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>client<span style="color:#f92672">.</span>py:<span style="color:#ae81ff">61</span><span style="color:#f92672">&gt;</span> result<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;8&#39;</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span>Task finished coro<span style="color:#f92672">=&lt;</span>send_message() done, defined at <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>cryan<span style="color:#f92672">/</span>repos<span style="color:#f92672">/</span>tomorrow<span style="color:#f92672">-</span>said<span style="color:#f92672">-</span>toad<span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>client<span style="color:#f92672">.</span>py:<span style="color:#ae81ff">61</span><span style="color:#f92672">&gt;</span> result<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;9&#39;</span><span style="color:#f92672">&gt;</span>},
</span></span><span style="display:flex;"><span> set())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">8</span>]: len(pool<span style="color:#f92672">.</span>pool)
</span></span><span style="display:flex;"><span>Out[<span style="color:#ae81ff">8</span>]: <span style="color:#ae81ff">5</span>
</span></span></code></pre></div>
        </section>
        <div class="post-tags">
          
          
          <nav class="nav tags">
            <ul class="tags">
              
              <li><a href="/tags/software">software</a></li>
              
              <li><a href="/tags/python">python</a></li>
              
            </ul>
          </nav>
          
          
        </div>
      </div>

      
      
    </div>

    </article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="mailto:colm@colmryan.org" rel="me" title="Email"><svg class="feather">
   <use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#mail" />
</svg></a><a class="border"></a><a class="soc" href="https://github.com/caryan/" rel="me" title="GitHub"><svg class="feather">
   <use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#github" />
</svg></a><a class="border"></a><a class="soc" href="https://gitlab.com/caryan" rel="me" title="GitLab"><svg class="feather">
   <use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#gitlab" />
</svg></a><a class="border"></a></div>
  <div class="footer-info">
    2025  © Colm Ryan |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>



</div>
    </body>
</html>
